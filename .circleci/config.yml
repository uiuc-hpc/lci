executor_default: &executor_default
  machine:
      image: ubuntu-2204:current

# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

jobs:
  install_dependencies:
    <<: *executor_default
    resource_class: medium
    steps:
      - run:
          name: Install dependencies
          command: |
            export DEBIAN_FRONTEND=noninteractive
            sudo apt-get update
            sudo apt-get install -y cmake ninja-build libfabric-bin libfabric-dev openmpi-bin openmpi-common openmpi-doc libopenmpi-dev clang-format python3-pip python3-venv
      - run:
          name: Setup Virtual Environment and Install CMake-Format
          command: |
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade cmake-format
      - run:
          name: Verify installations
          command: |
            cmake --version
            ninja --version
            mpicc --version
            mpirun --version
            fi_info --version
      - save_cache:
          key: apt-cache-v1
          paths:
            - /var/cache/apt/archives  # Cache downloaded .deb packages
            - /var/lib/apt/lists  # Cache APT package lists
    
  test:
    <<: *executor_default
    resource_class: medium
    steps:
      - restore_cache:
            keys:
              - apt-cache-v1
      - checkout
      - run:
          name: Running CMake Configure
          command: |
            ls
            cmake \
                -S . \
                -B build \
                -DCMAKE_BUILD_TYPE=Debug \
                -DLCI_DEBUG=ON \
                -DLCI_NETWORK_BACKENDS=ofi,ibv \
                -DLCT_PMI_BACKEND_ENABLE_MPI=ON \
                -DLCI_USE_CTEST_ARGS="--oversubscribe"
      - run:
          name: Running CMake Build
          command: |
            cmake --build build --target all
      - run:
          name: Running CTest excluding LCIT tests
          command: |
            ulimit -c unlimited
            export LCT_PMI_BACKEND=local
            ctest --extra-verbose --timeout 180 \
                  --test-dir build \
                  --output-junit ctest.out.xml
      - store_test_results:
          path: build/ctest.out.xml

workflows:
  version: 2
  build-and-test:
    jobs:
      - install_dependencies
      - test:
          requires:
            - install_dependencies